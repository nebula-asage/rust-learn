# ユーザ管理システム実装のポイント

## 1. アーキテクチャ設計

### モジュール分割によるクリーンアーキテクチャの実現

- **User (モデル層)**
  - ユーザデータの構造定義
  - シリアライズ/デシリアライズのための実装
  - 基本的なデータ構造のテスト

- **UserCommand (プレゼンテーション層)**
  - コマンドライン引数の処理
  - ユーザーインターフェース
  - 結果の表示フォーマット
  - コマンド実行の制御フロー

- **UserService (ビジネスロジック層)**
  - 入力値のバリデーション
  - ビジネスルールの実装
  - エラーハンドリング
  - モックを使用したテスト

- **UserRepository (データアクセス層)**
  - データの永続化処理
  - JSONファイルの読み書き
  - 環境変数による設定
  - 一時ファイルを使用したテスト

## 2. バリデーション実装

### 堅牢な入力チェック

- **メールアドレス**
  - 正規表現によるフォーマット検証
  - RFC準拠のパターンマッチング

- **ユーザ名**
  - 最小長チェック（3文字以上）
  - 空文字列のチェック

- **電話番号**
  - 数字のみで構成されていることの確認
  - 最小桁数チェック（10桁以上）

- **年齢**
  - 有効範囲チェック（0〜150歳）
  - 数値型の妥当性確認

## 3. エラーハンドリング

### 階層的なエラー管理

- **UserError列挙型の定義**
  - InvalidEmail
  - InvalidUsername
  - InvalidPhone
  - InvalidAge
  - UserNotFound
  - UserAlreadyExists
  - RepositoryError

- **エラーの伝播**
  - ? 演算子を使用した簡潔なエラーハンドリング
  - エラーメッセージの適切な変換

## 4. テスト実装

### 各層のテストカバレッジ

- **モデル層のテスト**
  - 構造体の生成
  - シリアライズ/デシリアライズ

- **サービス層のテスト**
  - モックを使用した依存性の分離
  - バリデーションロジックの検証
  - エラーケースの網羅

- **リポジトリ層のテスト**
  - 一時ファイルを使用したファイル操作
  - CRUD操作の検証

- **コマンド層のテスト**
  - 引数パースの検証
  - 出力フォーマットの確認

## 5. データ永続化

### JSONファイルベースのストレージ

- **設定の柔軟性**
  - 環境変数`USER_DATA_FILE`による保存先の設定
  - デフォルト値の提供

- **ファイル操作**
  - アトミックな読み書き操作
  - エラー時の適切なロールバック

- **データフォーマット**
  - 人間可読なJSON形式
  - 効率的なメモリ使用

## 6. 拡張性とメンテナンス性

### 将来の機能追加を考慮した設計

- **トレイト使用によるインターフェース分離**
  - `UserRepositoryTrait`の実装
  - モックテストの容易さ

- **モジュール構成**
  - 適切な可視性制御
  - 明確な依存関係

- **エラー処理**
  - カスタムエラー型による拡張性
  - 詳細なエラーメッセージ

## 7. 開発環境

### 必要な依存クレート

```toml
[dependencies]
mockall = "0.13.1"           # モックオブジェクトの生成
serde = { version = "1.0.228", features = ["derive"] }  # シリアライズ/デシリアライズ
serde_json = "1.0.145"       # JSON処理
regex = "1.10.2"            # 正規表現によるバリデーション
tempfile = "3.10.0"         # テスト用の一時ファイル
```